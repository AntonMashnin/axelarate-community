---
id: btc-consolidation-tx
sidebar_position: 1
sidebar_label: Bitcoin Consolidation Transaction
slug: /btc-consolidation-tx
---
# Транзакция консолидации Мастер-Ключ

```
Консолидация мастер-ключа - это процесс перевода средств с главного/мастер счёта на вспомогательный.
```

Чтобы выполнить транзакцию консолидации мастер-ключ в сети Биткойн, мы должны убедиться, что

1. Есть несколько UTXO с мастер-ключом, которые можно потратить
2. Все внешние ключи зарегистрированы

Чтобы отправить нескольком монет со вторичного ключа на главный ключ, нам нужно использовать флаг `--master-key-amount` при
выполнении `create-pending-transfers-tx`.

Далее нам нужно сгенерировать и зарегистрировать внешние ключи.

Генерация может осуществляться с помощью KMS -- следующая команда выполнит запись на диск закрытого ключа в кодировке WIF (будет использоваться для подписи) и выведит открытый ключ в шестнадцатеричной кодировке (для регистрации в Axelar).

ПРИМЕЧАНИЕ: Обязательно сохраняйте закрытые ключи, созданные при каждой итерации, чтобы их можно было использовать во время подписания ключей.

```
axelar-kms bitcoin keygen --force
```

Для регистрации внешних ключей, нам нужно использовать команду

```
axelard tx bitcoin register-external-keys \
  --key {external key name}:{external pubkey in hex} \
  --key {external key name}:{external pubkey in hex} \
  --key {external key name}:{external pubkey in hex} \
  --key {external key name}:{external pubkey in hex} \
  --key {external key name}:{external pubkey in hex} \
  --key {external key name}:{external pubkey in hex} \
  --from validator -y -b block --gas auto --gas-adjustment 1.2
```

После выполнения вышеуказанной настройки мы можем выполнить команды `create-master-tx`, `sign-tx`, и `submit-external-signature`, затем отправьте подписанную транзакцию в сеть Биткойн для завершения консолидации. Также доступна команда запроса `latest-tx`
для проверки статуса транзакции, и он готов к отправке, когда в поле статуса установлено значение `TX_STATUS_SIGNED`.

1. В случае, если на вторичном ключе недостаточно средств для обработки индивидуальных выводов, Вы возможно захотите отправить на него немного средств с мастера. Сначала найдите текущий вторичный ключ.
   ```
   axelard q bitcoin consolidation-address --key-role secondary
   ```

   Получите адрес и проверьте баланс последний транзакции в биткоин проводнике: blockstream.info.
   Следуйте аналогичному процессу, но замените `вторичный` на `мастер` и проверьте его баланс. 

   Если большая часть средств находится на `основном` ключе, тогда отправьте немного (например, 0,005) на вторичный ключ используя флаг `--secondary-key-amount 0.005btc` как показано в команде ниже:

   Создайте новый ключ. New_key_id должен быть последовательностью, учитывающей вывод вышеуказанного запроса адреса консолидации. Например, key_id из этого запроса `btc-primary-2`, Вм нужно выбрать `btc-primary-3` для new_key_id.

   ```
   axelard tx tss start-keygen --id {new_key_id} --from validator --gas auto --gas-adjustment 1.2
   ```

  Проверьте, статус ключа
   ```
   axelard q tss key <new_key_id>
   ```

   Создайте транзакцию с master-key используя флаг `--secondary-key-amount` чтобы отправить большинство монет обратно во
    вторичный ключ, как описано выше.

   Обратите внимание, что Вам нужно указать, какой ключ использовать для отправки полученных изменений. Если указанный ключ не соответствует текущему мастер-ключу, 
   присваивание ключа произойдет при создании транзакции и ротация ключей произойдет после завершения подписи. 
   Команда завершится ошибкой, если такая транзакция уже создана и ожидает завершения
   подписи. В таком случае подождите, пока система снова не станет доступной.
    ```
    axelard tx bitcoin create-master-tx {a key ID} --from validator --gas auto --gas-adjustment 1.2
    ```
2. Сгенерируйте внешние подписи для только что созданной транзакции.

    1. #### Получить TX json от axelard
       _В настоящее время у нас есть как минимум 3 из 6 ключей с несколькими подписями, поэтому в настоящее время нет необходимости собирать подписи от внешних сторон._
       ```
       axelard q bitcoin latest-tx --output json master
       ```

    2. #### Подпишите TX json с помощью KMS, используя $HOME/.axelar/private.key
       _Повторите следующее для каждого multisig ключа, который мы держим (необходимо только 3), при необходимости подставляя закрытый ключ._

       ```
       axelar-kms bitcoin sign {tx-json}
       ```
4. Отправьте внешние подписи для только что созданной транзакции.
    ```
    axelard tx bitcoin submit-external-signature {external key name} {external signature in hex} {sighash in hex} --from validator --gas auto --gas-adjustment 1.2
    ```
  Обратите внимание, что по умолчанию это нужно сделать для 3 внешних ключей.

5. Подписание триггера только что созданной транзакции с мастер-ключом.

  ```
  axelard tx bitcoin sign-tx master --from validator --gas auto --gas-adjustment 1.2
  ```

3. Подождите, пока транзакция не будет подписана. Обычно это занимает ~ 10 Axelar блоков.

  ```
  axelard q bitcoin latest-tx master
  ```

- Если вышеуказанный запрос вернет `TX_STATUS_SIGNED` в качестве `status(а)`, транзакция готова для передачи в сеть Биткойн
  
- Если вышеуказанный запрос вернет `TX_STATUS_ABORTED` в качестве `status(а)`, подпись по какой-то причине была звершена с ошибкой. Возможными причинами
  могут быть, но не ограничивается только этим списком:
    - Время подписи истекло из-за различных проблем с валидатором
    - Не удалось начать процесс подписания из-за того, что валидаторы не заявили о доступности TSS

Во всех случаях подпись можно повторить, снова вызвав `sign-tx`, как указано в шаге 2.

4. Отправьте подписанную транзакцию в сеть Биткойн

  ```
  axelard q bitcoin latest-tx master
  -> поле tx содержит шестнадцатеричное представление подписанной биткойн-транзакции
  ```

Затем Вы можете скопировать поле `tx` и отправить его в тестовую Биткойн сеть с помощью биткоин JSON-RPC API, или черз веб-интерфейс, такой как https://live.blockcypher.com/btc/pushtx/. Примечание выбирете тестовую сеть Биткойн в качестве цепи, если Вы используете интерфейс Blockcypher.

# Транзакция консолидации вторичного ключа (вывод)

Для обработки вывода средств пользователями в сети Биткойн, нам нужно инициировать транзакцию консолидации вторичного ключа. 
Для этого нам нужно использовать команды `create-pending-transfers-tx` и `sign-tx`, а затем отправьте подписанную транзакцию 
в сеть Биткойн. Также доступна команда запроса `latest-tx` для проверки статуса транзакции, 
она готова к отправке, в таком случае в поле статуса будет установлено значение TX_STATUS_SIGNED.

1. Создайте транзакцию с вторичным ключом для обработки всех ожидающих переводов в биткойн. Обратите внимание, что Вам нужно указать, 
   какой ключ использовать для отправки вывода изменений. Если указанный ключ не соответствует текущему вторичному ключу, присвоение 
   ключей произойдет при создании транзакции, а ротация ключей произойдет после завершения подписи. Команда завершится
   ошибкой, если такая транзакция уже создана и ожидает подписания. В таком случае подождите, пока
   система снова не станет доступной.

   Обычно мы хотим сначала найти текущий идентификатор вторичного биткоин ключа, а затем создать транзакцию с вторичным ключом.

  ```
  axelard q tss key-id bitcoin secondary
  ```

  ```
  axelard tx bitcoin create-pending-transfers-tx {a key ID} --from validator --gas auto --gas-adjustment 1.2
  ```

2. Подписание триггера только что созданной транзакции с вторичным ключом.

  ```
  axelard tx bitcoin sign-tx secondary --from validator --gas auto --gas-adjustment 1.2
  ```

3. Подождите, пока транзакция не будет подписана. Обычно это занимает ~ 10 Axelar блоков.

  ```
  axelard q bitcoin latest-tx secondary
  ```

- Если вышеуказанный запрос вернет `TX_STATUS_SIGNED` в качестве `status(а)`, транзакция готова к передачи в Биткоин 
  сеть.
- Если вышеуказанный запрос вернет `TX_STATUS_ABORTED` в качестве `status(а)`, выполнить подпись не удалось по какой-то из причин. Возможными причинами
  могут быть, но не ограничивается только этим списком:
    - Время подписи истекло из-за различных проблем с валидатором
    - Не удалось начать процесс подписания из-за того, что валидаторы не заявили о доступности TSS

Во всех случаях подпись можно повторить, снова вызвав `sign-tx`, как указано в шаге 2.

4. Отправьте подписанную транзакцию в Биткоин сеть 

  ```
  axelard q bitcoin latest-tx secondary
  -> поле tx содержит шестнадцатеричное представление подписанной биткойн-транзакции
  ```

Затем Вы можете скопировать поле `tx` и отправить его в тестовую Биткойн сеть с помощью биткоин JSON-RPC API, или черз веб-интерфейс, такой как https://live.blockcypher.com/btc/pushtx/. Примечание выбирете тестовую сеть Биткойн в качестве цепи, если Вы используете интерфейс Blockcypher.
